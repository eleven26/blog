---
title: Elasticsearch 删除数据
date: 2019-12-25 00:37:00
tags: [ElasticSearch]
---

本文中，我们将学习几种删除数据的方法：

* 删除单个文档或者一组文档。这样做的时候，Elasticsearch 只是将它们标记为删除，所以它们不会再出现于搜索结果中，
稍后 Elasticsearch 通过异步的方式将它们彻底地从索引中移出。

* 删除整个索引。这是删除多组文档的特例。但是不同点在于这样做的性能更好。
主要的工作就是移除和那个索引相关的所有文件，几乎是瞬间就能完成。

* 关闭索引。尽管这和删除无关，还是值得一提。关闭的索引不允许读取或者写入操作，数据也不会加载到内存。
这和删除 Elasticsearch 数据类似，但是索引还是保留在磁盘上。它也很容易恢复，只要再次打开关闭的索引。


## 删除文档

有几种方式移除单个文档，这里讨论主要的几个。

* 通过 ID 删除单个文档。如果只有一篇文档要删除，而且你知道它的 ID，这样做非常不错。

* 在单个请求中删除多篇文档。如果有多篇文档需要删除，可以在一个批量请求中一次性删除它们，这样比每次只删除一篇文档更快。

* 删除映射类型，包括其中的文档。这样的操作会高效地搜索并删除该类型中所索引的全部文档，也包括映射本身。

* 删除匹配某个查询的所有文档。这和删除映射类型相似，内部运行一个查询，并识别需要删除的文档。只有在这里可以指定任何想要的查询，然后删除匹配的文档。


1. 删除单个文档

为了删除单一的文档，需要向其 URL 发送 HTTP DELETE 请求。例如：

```
curl -XDELETE 'localhost:9200/online-shop/shirts/1'
```

也可以使用版本来管理删除操作的并发，就像索引和更新的并发控制一样。举个例子，假设某款衬衫销售一空，你想移除这篇文档，这样它就不会
出现在搜索结果中。但是当时你可能并不知道，新的采购到货了，而且库存数据也被更新了。为了避免这种情况，可以在 DELETE 请求中
加入版本 version 参数，就像索引和更新的操作那样。

尽管如此，删除的版本控制还是有个特殊情况。一旦删除了文档，它就不复存在了，于是一个更新操作很容易重新创建该文档，尽管这是不应该
发生的（因为更新的版本要比删除的版本更低）。由于外部版本可以用于不存在的文档上，使用外部版本时这个问题尤为突出。

为了防止这样的问题发生，Elasticsearch 将在一段时间内保留这篇文档的版本，如此它就能拒绝版本比删除操作更低的更新操作了。
默认情况下，这个时间是 60 秒，对于多数情况而应该足够了，但是你可以通过设置 elasticsearch.yml 文件中或者是每个索引配置中的
index.gc_deletes 来修改它。


2. 删除映射类型和删除查询匹配的文档


