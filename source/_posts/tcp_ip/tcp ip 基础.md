---
title: TCP/IP 基础
date: 2020-02-16 20:47:30
tags: [TCP/IP]
---


## 计算机网络体系结构分层

* OSI 七层模型

应用层

表示层

回话层

传输层

网络层

数据链路层

物理层

OSI 参考模型中定义了每一层的 "作用"，定义每一层作用的是 "协议"，"协议" 是约定，其具体内容为 "规范"，我们日常所使用的就是遵循各个协议具体 "规范" 的产品和通信手段。


* TCP/IP 概念层模型

应用层

传输层

网络层

链路层

OSI 参考模型注重 "通信协议必要的功能是什么"，而 TCP/IP 则更强调 "在计算机上实现协议应该开发哪种程序"。


## TCP/IP 基础

1. TCP/IP 的具体含义

从字面意义上讲，有人可能会认为 TCP/IP 是指 TCP 和 IP 两种协议。实际生活当中有时也确实就是指这两种协议。然而在很懂情况下，它只是利用 IP 进行通信时
必须用到的协议群的统称。具体来说，IP 或 ICMP、TCP 或 UDP、TELNET 或 FTP、以及 HTTP 等都属于 TCP/IP 协议。
他们与 TCP/IP 的关系紧密，是互联网必不可少的组成部分。TCP/IP 一词泛指这些协议，因此，有时也称 TCP/IP 为网际协议群。

互联网进行通信时，需要相应的网络协议，TCP/IP 原本就是为使用互联网开发制定的协议族。因此，互联网的协议就是 TCP/IP，TCP/IP 就是互联网协议。

应用协议：HTTP、SMTP、FTP、TELNET、SNMP

传输协议：TCP、UDP

路由控制协议：RIP、OSPF、BGP

网际协议：IP、ICMP、ARP


2. 数据包

包、帧、数据包、段、消息

以上 5 个术语都用来表述数据的单位，大致区分如下：

* 包可以说是全能性术语

* 帧用于表示数据链路层中包的单位

* 数据包是 IP 和 UDP 等网络层以上的分层包中的单位

* 段则表示 TCP 数据流中的信息

* 消息是指应用协议中数据的单位。

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。
通常，为协议提供的信息为包首部，所要发送的内容为数据。在下一层的角度看，从上一层收到的包全部都被认为是本层的数据。

网络中传输的数据包由两部分组成：一部分是协议所要用到的首部，另一部分是上一层传过来的数据。首部的结构由协议的具体规范详细定义。
在数据包的首部，明确标明了协议应该如何读取数据。反过来说，看到首部，也就能够了解该协议必要的信息以及所要处理的数据。包首部就像协议的脸。


3. 数据处理流程

下图以用户 a 向用户 b 发送邮件的例子：

![x](/images/tcp_ip/1.jpeg)


* 应用程序处理

首先应用程序会进行编码处理，这些编码相当于 OSI 的表示层功能；

编码转化后，邮件不一定马上被发送出去，这种何时建立通信连接何时发送数据的管理功能，相当于 OSI 的会话层的功能。

* TCP 模块的处理

TCP 根据应用的指示，负责建立连接、发送数据以及断开连接。TCP 提供将应用层发来的数据顺利发送至对端的可靠传输。

为了实现这一功能，需要在应用层数据的前端附加一个 TCP 首部。

* IP 模块的处理

IP  将 TCP 传过来的 TCP 首部和 TCP 数据结合起来当作自己的数据，并在 TCP 首部的前端加上自己的 IP 首部。

IP 包生成后，参考路由控制表决定接受此 IP 包的路由或主机。

* 网络接口（以太网驱动）的处理

从 IP 传过来的 IP 包对于以太网来说就是数据。给这些数据附加上以太网首部并进行发送处理，生成的以太网数据包将通过物理层传输给接收端。

* 网络接口（以太网驱动）的处理

主机接收到以太网包后，首先从以太网包首部找到 MAC 地址判断是否为发送给自己的包，若不是则丢弃数据。

如果是发送给自己的包，则从以太网包首部中的类型确定数据类型，再传给相应的模块，如 IP、ARP 等。这里的例子则是 IP。

* IP 模块的处理

IP 模块接收到数据后也做类似的处理。从包首部中判断此 IP 地址地址是否与自己的 IP 地址匹配，如果匹配则根据首部的协议类型将数据发送给对应的模块，如 TCP、UDP。这里的例子则是 TCP。

另外，对于有路由器的情况，接收端地址往往不是自己的地址，此时，需要借助路由控制表，在调查应该送往的主机或路由器之后再进行转发数据。

* TCP 模块的处理

在 TCP 模块中，首先会计算一下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。检查端口号，确定具体的应用程序。数据被完整地接收以后，会传给由端口号识别地应用程序。

* 应用程序的处理

接收端应用程序会直接接收发送端发送的数据。通过解析数据，展示相应的内容。


## 传输层中的 TCP 和 UDP

TCP/IP 中有两个具有代表性的传输层协议，分别是 TCP 和 UDP。

* TCP 是面向连接的、可靠的流协议。流就是指不间断的数据结构，当应用程序采用 TCP 发送消息时，虽然可以保证发送的顺序，但还是犹如没有任何间隔的数据流发送给接收端。
TCP 为提供可靠性传输，实现 "顺序控制" 或 "重发控制" 机制。此外还具备 "流控制（流量控制）"、"拥塞控制"、提高网络利用率等众多功能。

* UDP 是不具有可靠性的数据报协议。细微的处理它会交给上层的应用去完成。在 UDP 的情况下，虽然可以确保发送消息的大小，却不能保证消息一定会到达。
因此，应用有时会根据自己的需要进行重发处理。

* TCP 和 UDP 的优缺点无法简单地、绝对地去做比较：TCP 用于在传输层有必要实现可靠传输的情况；而在另一方面，UDP 主要用于那些对高速传输和实时性有较高要求的通信或广播通信。TCP 和 UDP 应该根据应用的目的按需使用。


1. 端口号

数据链路和 IP 中的地址，分别指的是 MAC 地址和 IP 地址。前者用来识别同一链路中不同的计算机，后者用来识别 TCP/IP 网络中互连的主机和路由器。
在传输层也有类似于地址的概念，那就是端口号。端口号用来识别同一台计算机中进行通信的不同应用程序。因此，它也被成为程序地址。


1.1 根据端口号识别应用

一台计算机上同时可以运行多个程序。传输层协议正是利用这些端口号识别本机中正在进行通信的应用程序，并准确地将数据传输。


![x](/images/tcp_ip/2.jpeg)


1.2 通过 IP 地址、端口号、协议号进行通信识别

* 仅凭目标端口号识别某一个通信是远远不够的

![x](/images/tcp_ip/3.jpeg)

![x](/images/tcp_ip/4.jpeg)

① 和 ② 的通信是在两台计算机上进行的。它们的目标端口号相同，都是 80。这里可以根据源端口号加以区分。

③ 和 ① 的目标端口号和源端口号完全相同，但它们各自的源 IP 地址不同。

此外，当 IP 地址和端口号全都一样时，我们还可以通过协议号来区分（TCP 和 UDP）。


1.3 端口号的确定

* 标准既定的端口号：这种方法也叫静态方法。它是指每个应用程序都有其指定的端口号。但并不是说可以随意使用任何一个端口号。例如 HTTP、FTP、TELNET 等广为使用的应用协议中所使用的端口号就是固定的。
这些端口号被成为知名端口号，分布在 0～1023 之间；除知名端口号外，还有一些端口号被正式注册，它们分布在 1024～49151 之间，不过这些端口号可用于任何通信用途。

* 时序分配法：服务器有必要确定监听端口号，但是接受服务的客户端没必要确定端口号。在这种方法下，客户端应用程序完全可以不用自己设置端口号，而全权交给操作系统进行分配。动态分配的端口范围在 49152~65535 之间。

1.4 端口号与协议

* 端口号由其使用的传输层协议决定。因此，不同的传输层协议使用相同的端口号。

* 此外，那些知名端口号与传输层协议并无关系。只要端口一致都将分配同一种应用程序进行处理。


2. UDP

* UDP 不提供复杂的控制机制，利用 IP 提供面向无连接的通信服务。

* 并且它是将应用程序发来的数据在接收到的那一刻，立刻按照原样发送到网络上的一种机制。即使是出现网络拥堵的情况，UDP 也无法进行流量控制等避免网络拥堵行为。

* 此外，传输途中出现丢包，UDP 也不负责重发。

* 甚至当包的到达顺序出现乱序时也没有纠正的功能。

* 如果需要以上的细节控制，不得不交由采用 UDP 的应用程序去处理。

* UDP 常用于以下几个方面：1. 包总量较少的通信（DNS、SNMP等）；2. 视频、音频等多媒体通信（即时通信）；3. 限定于 LAN 等特定网络中的应用通信；4. 广播通信（广播、多播）


3. TCP

* TCP 与 UDP 的区别相当大。它充分地实现了数据传输时的各种控制功能，可以进行丢包时的重发控制，还可以对次序乱掉的分包进行顺序控制。而这些在 UDP 中都没有。

* 此外，TCP 作为一种面向有连接的协议，只有在确认通信对端存在时才会发送数据，从而可以控制通信流量的浪费。

* 根据 TCP 的这些机制，在 IP 这种无连接的网络上也能够实现高可靠性的通信（主要通过校验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现）。


3.1 三次握手（重点）

* TCP 提供面向有连接的通信控制。面向有连接是指在数据通信开始之前先做好两端之间的准备工作。

* 所谓三次握手是指建立一个 TCP 连接时需要客户端和服务器端总共发送三个包以确认连接的建立。在 socket 编程中，这一过程由客户端执行 connect 来触发。

下面来看看三次握手的流程图：

![x](/images/tcp_ip/5.jpeg)


* 第一次握手：客户端将标志位 SYN 置为 1，随机产生一个值 seq = J，并将该数据包发送给服务器端，客户端进入 SYN_SENT 状态，等待服务器端确认。

* 第二次握手：服务器端收到数据包后由标志位 SYN=1 知道客户端请求建立连接，服务器端将标志位 SYN 和 ACK 都置为 1，ack=J+1，随机产生一个值 seq=K，
并将该数据包发送给客户端以确认连接请求，服务器端进入 SYN_RECVD 状态。

* 第三次握手：客户端收到确认后，检查 ack 是否为 J+1，ACK 是否为 1，如果正确则将标志位 ACNK 置为 1，ack=K+1，并将该数据包发送给服务器端，服务器端
检查 ack 是否为 K+1，ACK 是否为 1，如果正确则连接建立成功，客户端和服务器端进入 ESTABLISHED 状态，完成三次握手，随后客户端与服务器端之间可以开始传输数据了。
